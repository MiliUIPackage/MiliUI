--------------------------------------- 伺服器lag發話過濾-- @Author: 彩虹ui-------------------------------------local lagFilter = false			-- 是否要啟用過濾發話延遲local LagFilterAuto = false		-- 是否 "要" 使用定時開關								-- true: 會依據前一行的值，前一行也為 true 則永遠啟用。								-- false: 會使用定時開關，依據下一行的值自動開關。local startHour = 21			-- 自動啟用過濾發話延遲的開始時間，24小時制，結束時間為半夜12點。local isSwitched = falselocal isTinyChatEnabledlocal locale = GetLocale()local L = {    Say			= { zhTW = "說", zhCN = "说" },    Yell		= { zhTW = "大喊", zhCN = "大喊" },    NotInParty		= { zhTW = "不在隊伍中", zhCN = "队伍中" },    NotInRaid		= { zhTW = "不在一個團隊中", zhCN = "团队中" },}--過濾器local function filter(self, event, msg, ...)    if (TinyChatDB and TinyChatDB.LagFilter) and (string.find(msg, L["NotInParty"][locale] or "in a party", 1, true) or string.find(msg, L["NotInRaid"][locale] or "in a raid", 1, true)) then		return true	end	return false, msg, ...end--過濾器--[[local function filterOutAnyMsg()	return trueend--]]-- 單純開關聊天頻道，不需要 TinyChatlocal function ToggleChatMessageGroup(typeInfoKey, checked, channelName)	local frame = SELECTED_CHAT_FRAME or DEFAULT_CHAT_FRAME	if ( checked ) then		ChatFrame_AddMessageGroup(frame, typeInfoKey)		print(ENABLE .. CHANNEL .. "：" .. channelName)	else		ChatFrame_RemoveMessageGroup(frame, typeInfoKey)		print(CLOSE .. CHANNEL .. "：" .. channelName)	endend-- 離開副本關閉說和大喊，避免一直看到別人喊話local function SwitchChatGroupsInstance()	if IsInInstance() then		-- 副本內打開說和大喊		if isTinyChatEnabled then			if not ChatBar_IsListeningForChatType("SAY") then				ChatBar_ToggleChatMessageGroup(_G["ChatSwitchButton1"], true)			end			if not ChatBar_IsListeningForChatType("YELL") then				ToggleChatMessageGroup("YELL", true, L["Yell"][locale] or "Yell")			end		else			ToggleChatMessageGroup("SAY", true, L["Say"][locale] or "Say")			ToggleChatMessageGroup("YELL", true, L["Yell"][locale] or "Yell")		end		-- 關閉對話泡泡		if not TinyChatDB.BubbleManually and tonumber(C_CVar.GetCVar("ChatBubbles")) == 1 then			C_CVar.SetCVar("ChatBubbles", 0)			print(DISABLE..CHAT_BUBBLES_TEXT)		end	else		-- 副本外關閉說和大喊		if isTinyChatEnabled then			if ChatBar_IsListeningForChatType("SAY") then				ChatBar_ToggleChatMessageGroup(_G["ChatSwitchButton1"], false)			end			if ChatBar_IsListeningForChatType("YELL") then				ToggleChatMessageGroup("YELL", false, L["Yell"][locale] or "Yell")			end		else			ToggleChatMessageGroup("SAY", false, L["Say"][locale] or "Say")			ToggleChatMessageGroup("YELL", false, L["Yell"][locale] or "Yell")		end	endend-- 打開說，恢復原狀local function ResetChatGroups()	if isTinyChatEnabled then		if not ChatBar_IsListeningForChatType("SAY") then			ChatBar_ToggleChatMessageGroup(_G["ChatSwitchButton1"], true)		end		if not ChatBar_IsListeningForChatType("YELL") then			ToggleChatMessageGroup("YELL", true, L["Yell"][locale] or "Yell")		end	else		ToggleChatMessageGroup("SAY", true, L["Say"][locale] or "Say")		ToggleChatMessageGroup("YELL", true, L["Yell"][locale] or "Yell")	endendlocal function OnEvent(self, event, arg1, ...)	if event == "PLAYER_ENTERING_WORLD" then		isTinyChatEnabled = C_AddOns.IsAddOnLoaded("TinyChat")		if not TinyChatDB then TinyChatDB = {} end		if not isTinyChatEnabled then -- 沒有使用 TinyChat 時依據開頭的變數設定			TinyChatDB.LagFilter = lagFilter 			TinyChatDB.LagFilterAuto = LagFilterAuto 		end		if TinyChatDB.LagFilterAuto then			-- 定時開關			-- 檢查時間，自動開關此功能			local hour = tonumber(date("%H"))			if hour >= startHour then				-- 在時間內，如果是關的把它打開				if not TinyChatDB.LagFilter then					TinyChatDB.LagFilter = true					-- print(ENABLE .. (L["ToggleLag"][locale] or "Chat message delay filter"))				end				SwitchChatGroupsInstance()				isSwitched = true			else				-- 不在時間內，如果是開的把它關閉，並且恢復按鈕				if TinyChatDB.LagFilter then					TinyChatDB.LagFilter = false					-- print(DISABLE .. (L["ToggleLag"][locale] or "Chat message delay filter"))				end				ResetChatGroups()			end		else			-- 手動開關			-- 如果是開的就切換按鈕			if TinyChatDB.LagFilter then  -- 避免和 ZONE_CHANGED_NEW_AREA 重複觸發				SwitchChatGroupsInstance()				isSwitched = true			-- else				-- 如果是關的就不動按鈕				-- ResetChatGroups()			end		end	elseif TinyChatDB.LagFilter then -- event == "ZONE_CHANGED_NEW_AREA"		-- 切換區域/進出副本時，如果是開的就切換按鈕		if isSwitched then -- 先檢查是否已經切換過，避免兩種事件連續切換兩次			isSwitched = false		else			SwitchChatGroupsInstance()		end	endendlocal f = CreateFrame("Frame")f:RegisterEvent("PLAYER_ENTERING_WORLD")f:RegisterEvent("ZONE_CHANGED_NEW_AREA")f:SetScript("OnEvent", OnEvent)ChatFrame_AddMessageEventFilter("CHAT_MSG_SYSTEM", filter)-- 過濾掉所有 不願被打擾 自動回覆的廣告訊息-- ChatFrame_AddMessageEventFilter("CHAT_MSG_DND", filterOutAnyMsg)